# v2.3 Release Notes - Embedding Sync Optimization

**Release Date:** January 11, 2026

---

## Overview

Version 2.3 delivers a **10x throughput improvement** to the embedding sync pipeline through batch size optimization, async I/O, and improved error handling. This release also includes bug fixes for the UI and database layer.

### Highlights

- **10x Faster Embedding Sync** - Batch optimizations and async writes reduce sync time from 24+ hours to 15-30 minutes
- **Async Qdrant Writes** - Non-blocking vector database writes with end-of-sync verification
- **OpenAI API Retry Logic** - Exponential backoff for rate limits and transient errors
- **Progress Monitoring** - 30-second interval logging for observability
- **Selective Sync** - New `SYNC_COLLECTION` env var for syncing specific entity types
- **Bug Fixes** - Fixed duplicate Similar Games header and PostgreSQL column ambiguity

---

## Embedding Sync Optimizations

### Batch Size Configuration

| Entity | Before | After | Notes |
|--------|--------|-------|-------|
| Games (DB fetch) | 100 | 500 | 5x increase |
| Qdrant upsert | 100 | 500 | 5x increase |
| Publishers | 500 | 200 | Reduced to avoid RPC timeout |
| Developers | 500 | 100 | Smallest due to complex aggregation query |

**Rationale:**
- Games use larger batches (500) because the database query is relatively simple
- Publishers use moderate batches (200) to avoid hitting Supabase's 8-second statement timeout
- Developers use smaller batches (100) because the RPC function performs complex aggregations including indie detection (same name as publisher)

### Async Qdrant Writes

Changed from blocking (`wait: true`) to non-blocking (`wait: false`) writes:

```typescript
// Before: Blocked until Qdrant indexed each batch
await qdrantClient.upsert(collection, { points, wait: true });

// After: Continue processing while Qdrant indexes in background
await qdrantClient.upsert(collection, { points, wait: false });
```

**Benefits:**
- Worker continues processing immediately after write
- Qdrant indexes data in parallel with embedding generation
- Collection verification at sync completion ensures data integrity

### OpenAI API Retry Logic

Added comprehensive retry handling for embedding generation:

```typescript
const retryConfig = {
  maxRetries: 3,
  initialDelay: 1000,  // 1 second
  maxDelay: 10000,     // 10 seconds
  backoffMultiplier: 2 // Exponential: 1s → 2s → 4s
};
```

**Retryable Errors:**
- HTTP 429 (Rate limit exceeded)
- HTTP 500, 502, 503, 504 (Server errors)
- Network timeouts
- Connection errors

**Non-Retryable Errors:**
- HTTP 400 (Bad request)
- HTTP 401 (Authentication)
- HTTP 403 (Forbidden)

### Progress Logging

New `startProgressLogging()` function provides visibility into long-running syncs:

```
[30s] Elapsed: 0.5min | Processed: 1500 | Skipped: 42 | Tokens: 450000 | Rate: 3000/min
[60s] Elapsed: 1.0min | Processed: 3100 | Skipped: 85 | Tokens: 920000 | Rate: 3100/min
```

Logs include:
- Elapsed time in minutes
- Items processed count
- Items skipped (unchanged hash)
- OpenAI tokens consumed
- Processing rate (items/minute)

### GitHub Workflow Changes

| Parameter | Before | After |
|-----------|--------|-------|
| Timeout | 120 minutes | 60 minutes |
| Default batch | 100 | 500 |

**New Inputs:**
- `batch_size` - Override default batch size for manual runs
- `sync_collection` - Selective sync: `all`, `games`, `publishers`, `developers`

**New Environment Variable:**
- `SYNC_COLLECTION` - Controls which entity types to sync

---

## Bug Fixes

### Duplicate Similar Games Header (f53456f)

**Problem:** The SimilaritySection component rendered its own header even when the parent AppDetailSections component was already providing one, resulting in duplicate headers on the app detail page.

**Solution:** Added `showHeader` prop to SimilaritySection component:

```typescript
interface SimilaritySectionProps {
  appid: number;
  showHeader?: boolean; // New prop, default: true
}

// In AppDetailSections.tsx
<SimilaritySection appid={appid} showHeader={false} />
```

**Files Modified:**
- `apps/admin/src/app/(main)/apps/[appid]/AppDetailSections.tsx`
- `apps/admin/src/components/similarity/SimilaritySection.tsx`

### PostgreSQL Ambiguous Column Reference (30bb7d9)

**Problem:** PostgreSQL error 42702 in `get_apps_for_embedding` functions - the `appid` column reference was ambiguous because it conflicted with the PL/pgSQL return column variable of the same name.

**Solution:** Qualified all column references in the `app_steamspy_tags` CTE:

```sql
-- Before (ambiguous)
SELECT appid, ...
FROM app_tags
WHERE appid = ANY(...)

-- After (explicit)
SELECT app_tags.appid, ...
FROM app_tags
WHERE app_tags.appid = ANY(...)
```

**Additional Fix:** Corrected `language_count` calculation:

```sql
-- Before (incorrect for JSONB objects)
jsonb_array_length(a.languages)

-- After (correct for JSONB objects)
(SELECT COUNT(*) FROM jsonb_object_keys(a.languages))
```

**Migration:** `20260111212338_fix_embedding_appid_ambiguity.sql`

---

## Code Cleanup

### Removed Unused p-limit Dependency (9eb8b05)

Removed unused concurrency limiter after moving to batch-based async processing:

```typescript
// Removed
import pLimit from 'p-limit';
const OPENAI_CONCURRENCY = 4;
const openaiLimit = pLimit(OPENAI_CONCURRENCY);
```

---

## Performance Impact

| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| Full sync time | 24+ hours | 15-30 minutes | ~50x |
| Throughput | ~50 items/min | ~500 items/min | 10x |
| API efficiency | Blocking I/O | Async + retry | Improved |

**Contributing Factors:**
1. 5x larger batches reduce database round-trips
2. Async Qdrant writes eliminate blocking I/O
3. Retry logic prevents full failures on transient errors
4. Progress logging enables bottleneck identification

---

## Configuration Reference

### Batch Sizes (`embedding-worker.ts`)

```typescript
const GAME_BATCH_SIZE = 500;      // Games from DB per batch
const QDRANT_BATCH_SIZE = 500;    // Points per Qdrant upsert
const PUBLISHER_BATCH_SIZE = 200; // Smaller to avoid RPC timeout
const DEVELOPER_BATCH_SIZE = 100; // Smallest due to complex query
```

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `SYNC_COLLECTION` | `all` | Which collections to sync: `all`, `games`, `publishers`, `developers` |
| `BATCH_SIZE` | 500 | Override default game batch size |

---

## Database Migrations

| Migration | Purpose |
|-----------|---------|
| `20260111212338_fix_embedding_appid_ambiguity.sql` | Fix column ambiguity and language count calculation |

---

## Related Documentation

- [Sync Pipeline](../developer-guide/architecture/sync-pipeline.md) - Full embedding sync architecture
- [v2.2 Release Notes](v2.2-ccu-steamspy.md) - Previous release
