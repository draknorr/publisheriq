# v2.2 Release Notes - Tiered CCU & SteamSpy Improvements

**Release Date:** January 9, 2026
**Updated:** January 10, 2026

---

## Overview

Version 2.2 introduces intelligent tiered CCU (concurrent user) tracking using Steam's native API, along with improvements to SteamSpy data collection, rate limits, and priority calculation. This release focuses on data quality and collection efficiency.

### Highlights

- **Insights Dashboard** - New analytics page with CCU sparklines, trend visualization, and metrics
- **Tiered CCU Tracking** - Three-tier system with hourly, 2-hourly, and daily polling based on game activity
- **Exact CCU Data** - Direct Steam API integration replaces SteamSpy estimates for player counts
- **CCU Rotation Tracking** - 3x daily Tier 3 polling with `last_ccu_synced` ensures full coverage every ~2 days
- **CCU Skip Tracking** - Invalid appids automatically skipped for 30 days, reducing wasted API calls
- **Store Asset Mtime** - PICS-sourced page creation dates replace broken Community Hub scraper
- **SteamSpy Supplementary Fetch** - Fills gaps in SteamSpy pagination for popular games
- **3x Reviews Throughput** - Rate limit increased from 0.33 to 1 req/sec
- **Priority Fix** - Never-synced apps now receive proper priority for initial enrichment

---

## Tiered CCU Tracking System

### Overview

Replaces simple hourly polling with an intelligent three-tier system that optimizes API calls based on game activity levels.

### Tier Definitions

| Tier | Criteria | Polling Frequency | Games |
|------|----------|-------------------|-------|
| **Tier 1** | Top 500 by 7-day peak CCU | Hourly | ~500 |
| **Tier 2** | Top 1000 newest releases (past year) | Every 2 hours (even hours only) | ~1000 |
| **Tier 3** | All other games | 3x daily (8 hours apart, rotation) | ~120,000+ |

### Data Flow

```
Steam GetNumberOfCurrentPlayers API
          ↓
ccu-tiered-worker (hourly, Tier 1+2)
          ↓
ccu_snapshots (30-day retention)
          ↓
ccu-cleanup workflow (weekly)
          ↓
daily_metrics (ccu_peak, ccu_source='steam_api')
```

### New Database Tables

#### `ccu_snapshots`

Stores hourly/2-hourly CCU snapshots for Tier 1+2 games.

| Column | Type | Description |
|--------|------|-------------|
| id | BIGSERIAL | Primary key |
| appid | INTEGER | FK to apps |
| snapshot_time | TIMESTAMPTZ | Snapshot timestamp |
| player_count | INTEGER | Exact CCU from Steam API |
| ccu_tier | SMALLINT | Tier at snapshot time (1/2/3) |

**Retention:** 30 days, then aggregated to `daily_metrics`

#### `ccu_tier_assignments`

Current tier assignment for each game, recalculated hourly.

| Column | Type | Description |
|--------|------|-------------|
| appid | INTEGER | PK, FK to apps |
| ccu_tier | SMALLINT | Current tier (1/2/3) |
| tier_reason | TEXT | 'top_ccu', 'new_release', 'default' |
| recent_peak_ccu | INTEGER | 7-day peak CCU |
| release_rank | INTEGER | Rank by release date (for Tier 2) |
| last_tier_change | TIMESTAMPTZ | When tier last changed |
| updated_at | TIMESTAMPTZ | Last update time |
| ccu_fetch_status | TEXT | Last fetch result: 'valid', 'invalid', 'error' |
| ccu_skip_until | TIMESTAMPTZ | Skip invalid appids until this time (30-day skip) |
| last_ccu_synced | TIMESTAMPTZ | Last CCU sync time (for Tier 3 rotation) |

### New Column: `daily_metrics.ccu_source`

Tracks data provenance:
- `'steam_api'` - Exact CCU from Steam's GetNumberOfCurrentPlayers API
- `'steamspy'` - Estimated CCU from SteamSpy
- `NULL` - Legacy data (source unknown)

### New RPC Functions

| Function | Purpose |
|----------|---------|
| `recalculate_ccu_tiers()` | Reassigns tiers based on 7-day peak CCU and release date |
| `cleanup_old_ccu_snapshots()` | Deletes snapshots older than 30 days |
| `aggregate_daily_ccu_peaks(target_date)` | Rolls up hourly snapshots to daily_metrics |

### New Workers

#### CCU Tiered Worker (`ccu-tiered-worker.ts`)

- Runs hourly via GitHub Actions
- Polls Tier 1 games every hour
- Polls Tier 2 games every 2 hours (even hours only)
- Creates `ccu_snapshots` records
- Updates `daily_metrics` with peak values
- Recalculates tier assignments at midnight UTC

```bash
pnpm --filter @publisheriq/ingestion ccu-tiered-sync
```

#### CCU Daily Worker (`ccu-daily-worker.ts`)

- Runs 3x daily (04:30, 12:30, 20:30 UTC) for complete rotation coverage
- Polls Tier 3 games sorted by `last_ccu_synced ASC NULLS FIRST`
- Each run processes ~21k games (6-hour timeout at 1 req/sec)
- Full Tier 3 coverage (~120k games) achieved every ~2 days
- Skips apps with active `ccu_skip_until` (invalid appids)
- Supports `CCU_DAILY_LIMIT` env var (default: 150,000)

```bash
pnpm --filter @publisheriq/ingestion ccu-daily-sync
```

### New GitHub Workflows

| Workflow | Schedule | Purpose |
|----------|----------|---------|
| `ccu-sync.yml` | Hourly at :00 | Tier 1+2 CCU polling |
| `ccu-daily-sync.yml` | 3x daily (04:30, 12:30, 20:30 UTC) | Tier 3 CCU polling with rotation |
| `ccu-cleanup.yml` | Weekly Sun 3 AM UTC | Aggregate + cleanup old snapshots |
| `cleanup-reservations.yml` | Hourly at :00 | Cleanup stale credit reservations |

### Benefits

- **Exact Data**: Steam API returns real-time player counts, not estimates
- **Hourly Granularity**: Top games tracked every hour for accurate peak detection
- **Automatic Tier Movement**: Games automatically move between tiers as activity changes
- **Efficient Resource Use**: Low-activity games polled less frequently
- **Trend Analysis**: 30-day snapshot retention enables CCU trend visualization

---

## CCU Rotation Tracking System

### Problem

With ~120,000 Tier 3 games and a 6-hour GitHub Actions timeout at 1 req/sec, a single daily run could only sync ~21,000 games. This meant many games were never getting CCU data.

### Solution

Implemented rotation tracking via `last_ccu_synced` column:

1. **3x Daily Schedule**: Runs at 04:30, 12:30, 20:30 UTC (8 hours apart)
2. **Oldest-First Ordering**: Queries games by `last_ccu_synced ASC NULLS FIRST`
3. **Full Coverage**: Each run processes ~21k games → full rotation every ~2 days

### How It Works

```sql
-- Query orders by oldest sync first, never-synced games prioritized
SELECT appid FROM ccu_tier_assignments
WHERE ccu_tier = 3
  AND (ccu_skip_until IS NULL OR ccu_skip_until < NOW())
ORDER BY last_ccu_synced ASC NULLS FIRST
LIMIT 150000;
```

After each successful CCU fetch, `last_ccu_synced` is updated:
```sql
UPDATE ccu_tier_assignments
SET last_ccu_synced = NOW()
WHERE appid = $1;
```

### Migration

`20260111000001_add_last_ccu_synced.sql` - Adds `last_ccu_synced` column to `ccu_tier_assignments`

---

## CCU Invalid AppID Skip Tracking

### Problem

~10-15% of Steam appids return `result: 42` (invalid/no data) from the CCU API. Without skip tracking, these apps waste API calls on every sync run.

### Solution

Added skip tracking columns to `ccu_tier_assignments`:

| Column | Type | Description |
|--------|------|-------------|
| `ccu_fetch_status` | TEXT | Last result: 'valid', 'invalid', 'error' |
| `ccu_skip_until` | TIMESTAMPTZ | Skip until this time (30 days for invalid) |

### Behavior

1. **Valid Response (result: 1)**: Update CCU, set `ccu_fetch_status = 'valid'`, clear skip
2. **Invalid Response (result: 42)**: Set `ccu_fetch_status = 'invalid'`, set `ccu_skip_until = NOW() + 30 days`
3. **Network Error**: Set `ccu_fetch_status = 'error'`, no skip (transient)

### Benefits

- Reduces wasted API calls by 10-15%
- Invalid apps automatically re-checked after 30 days
- Network errors don't trigger long-term skips

### Migration

`20260110000004_add_ccu_skip_tracking.sql` - Adds skip tracking columns

---

## Store Asset Mtime (PICS)

### Problem

The page creation scraper (`scraper-worker.ts`) was looking for a "Founded" date on Steam Community Hub pages. However, this date only exists on Steam Group pages (like Valve's company page), not on individual game community pages. The scraper ran for ~68% of apps but found exactly 0 dates.

### Solution

PICS data includes `store_asset_mtime` - the timestamp when the Steam store page was created. This is now used instead of scraping.

### Changes

1. **Schema Change**: `apps.page_creation_date` → `apps.store_asset_mtime`
2. **Worker Removed**: Deleted `scraper-worker.ts` and `page-creation.ts`
3. **Workflow Removed**: Deleted `page-creation-scrape.yml`
4. **PICS Integration**: `store_asset_mtime` populated during PICS sync

### Database Migration

```sql
-- Rename column
ALTER TABLE apps RENAME COLUMN page_creation_date TO store_asset_mtime;
ALTER TABLE apps DROP COLUMN IF EXISTS page_creation_date_raw;

-- Remove sync_status columns
ALTER TABLE sync_status DROP COLUMN IF EXISTS last_page_creation_scrape;
ALTER TABLE sync_status DROP COLUMN IF EXISTS needs_page_creation_scrape;
```

### Migrations

- `20260110000005_add_store_asset_mtime.sql` - Rename column, update PICS service
- `20260110000006_remove_scraper_from_sync_functions.sql` - Remove scraper references from sync functions

---

## Race Condition Fix

### Problem

Concurrent storefront sync workers could cause duplicate key violations when inserting publishers/developers with different casing (e.g., "Valve" vs "VALVE").

### Solution

Changed ON CONFLICT clause to use `normalized_name` (case-insensitive, lowercase) instead of `name`:

```sql
INSERT INTO publishers (name, normalized_name, ...)
VALUES ($1, LOWER(TRIM($1)), ...)
ON CONFLICT (normalized_name) DO UPDATE SET ...  -- Was: ON CONFLICT (name)
```

### Migration

`20260110000001_fix_ci_conflict_detection.sql` - Updates upsert functions

---

## Insights Dashboard

### Overview

New analytics page at `/insights` that visualizes CCU data with sparklines and comprehensive metrics. Built on the tiered CCU tracking system.

### Three Tabs

| Tab | Description | Sorting |
|-----|-------------|---------|
| **Top Games** | Top 50 games by peak CCU in selected time range | By peak CCU |
| **Newest** | Games released in past year with CCU data | By Release / By CCU Growth (toggle) |
| **Trending** | Top 50 games by CCU growth percentage | By growth % |

### Features

**Inline Sparklines**
- Visual CCU trends over 24h/7d/30d periods
- Downsampled to 12-15 data points
- Color-coded: Green (up), Red (down), Blue (stable)
- Growth percentage displayed alongside

**Metrics per Game**
- Peak CCU with trend sparkline
- Total reviews with positive percentage (color-coded)
- Review velocity (reviews per day)
- Price with discount badge
- Average playtime in hours

**Time Range Selector**
- 24h: Hourly granularity, 12 sparkline points
- 7d: Daily granularity, 14 sparkline points (default)
- 30d: Daily granularity, 15 sparkline points

**Newest Tab Sort Toggle**
- "By Release" - Newest games first
- "By CCU Growth" - Highest growth percentage first
- URL parameter persistence (`?sort=growth`)

### File Structure

```
apps/admin/src/app/(main)/insights/
├── page.tsx                    # Server component with parallel data fetch
├── InsightsTabs.tsx            # Tab state management (client)
├── lib/
│   ├── insights-types.ts       # TypeScript definitions
│   └── insights-queries.ts     # Data fetching
└── components/
    ├── TopGamesTab.tsx
    ├── NewestGamesTab.tsx
    ├── TrendingGamesTab.tsx
    ├── TopGameCard.tsx         # Row with sparkline
    ├── TimeRangeSelector.tsx
    └── InsightsSkeleton.tsx
```

### Data Sources

| Data | Source |
|------|--------|
| CCU, sparklines | `ccu_snapshots` table |
| Reviews, price, playtime | `latest_daily_metrics` view |
| Review velocity | `app_trends` table |
| Game metadata | `apps` table |

### Responsive Design

Columns hide progressively on smaller screens:
- xs: Game name + CCU only
- sm: + Reviews
- md: + Price
- lg: + Playtime

---

## SteamSpy Supplementary Fetch

### Problem

SteamSpy's paginated "all" API returns only ~86,000 apps, missing some popular games like Arc Raiders (120K reviews) that are available via the individual `appdetails` endpoint.

### Solution

Added supplementary fetch logic to `steamspy-worker.ts` that:
1. Identifies games with 1000+ reviews but no SteamSpy data
2. Fetches individual app details via `appdetails` endpoint
3. Runs during full sync, adds ~2 minutes to 90-minute sync

### New Database Column

`sync_status.last_steamspy_individual_fetch` - Tracks when individual fetch was attempted

### New RPC Function

`get_steamspy_individual_fetch_candidates(p_limit, p_min_reviews)` - Returns high-priority games missing from SteamSpy pagination

### Configuration

| Environment Variable | Default | Description |
|---------------------|---------|-------------|
| `SUPPLEMENTARY_LIMIT` | 100 | Max games per supplementary fetch |

---

## Rate Limit & Batch Size Changes

### Reviews API

| Parameter | Before | After | Improvement |
|-----------|--------|-------|-------------|
| Rate limit | 0.33 req/sec | 1 req/sec | 3x |
| Batch size | 1,200 apps | 2,500 apps | 2x |
| Daily capacity | ~14,000 apps | ~30,000 apps | 2x |

**Rationale:** Reviews API uses lightweight summary endpoint (`num_per_page=0`) that only returns aggregate counts, not individual reviews.

### Steam CCU API

New rate limiter added:
- **Rate:** 1 req/sec (conservative)
- **Burst:** 5 requests

---

## Priority Calculation Fix

### Problem

Never-synced apps were incorrectly receiving the "dead game" penalty (-50 points), causing them to never be prioritized for initial data enrichment. This affected ~11,000 games including titles like ARC Raiders.

### Fix

Never-synced apps now receive a base priority of 25 (moderate tier), ensuring:
- Initial sync within 48 hours
- Proper discovery in chat queries
- Correct categorization after first metrics collection

### Priority Algorithm

```javascript
// Before: All apps without metrics got dead penalty
if (ccu === 0 && velocity7d < 0.1) {
  priority -= 50; // ❌ Applied to never-synced apps
}

// After: Only previously-synced apps get dead penalty
const neverSynced = !app.last_reviews_sync && !app.last_steamspy_sync;
if (neverSynced) {
  priority = 25; // Base priority for new games
} else if (ccu === 0 && velocity7d < 0.1) {
  priority -= 50; // Only for previously-synced inactive games
}
```

---

## Materialized View Auto-Refresh

### New Function

`refresh_mat_views()` - Concurrently refreshes all materialized views:
- `latest_daily_metrics`
- `publisher_metrics`
- `developer_metrics`
- `publisher_year_metrics`
- `developer_year_metrics`
- `publisher_game_metrics`
- `developer_game_metrics`
- `review_velocity_stats`

### New Workflow

`refresh-views.yml` runs:
- Daily at 5 AM UTC
- After `steamspy-sync` completes (workflow dispatch)

---

## DailyMetrics Cube Fix

Removed invalid `name` dimension from DailyMetrics Cube.js model. The dimension was causing cross-cube reference errors. Name-based queries should use:
- `lookup_games` tool for name → appid resolution
- `Discovery` cube for game data with names

---

## Magic Link Auth Fix

### Problem

Magic links using PKCE flow failed when users clicked links from email clients (Gmail, Outlook) that opened in different browser contexts. The PKCE code verifier stored in localStorage was inaccessible in the new browser context.

### Solution

Switched to implicit flow, which sends tokens directly in the URL hash fragment:

```ts
// apps/admin/src/lib/supabase/client.ts
createBrowserClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    flowType: 'implicit', // Was: 'pkce' (default)
  },
})
```

**Changes:**
- Browser client: Added `flowType: 'implicit'` to config
- Callback page: Removed PKCE code exchange, simplified to hash-based detection
- Middleware: Removed PKCE redirect handling

---

## PICS Release Date Fix

### Problem

PICS service was unconditionally overwriting `release_date`, even when storefront had already synced the correct date. This caused incorrect dates for some games (e.g., Medieval Merchant showing Jan 31 instead of Jan 5).

### Solution

Made PICS release date a fallback - only set when storefront hasn't provided a date:

```python
# Only update release_date if storefront hasn't already set it
if app['release_date_raw'] is None:
    updates['release_date'] = pics_release_date
```

**Preserves:** PICS-only dates for ~277 apps without storefront data

---

## Database Migrations

| Migration | Purpose |
|-----------|---------|
| `20260110000001_add_steamspy_individual_fetch_tracking.sql` | Supplementary fetch column |
| `20260110000001_fix_ci_conflict_detection.sql` | Race condition fix for publisher/developer upserts |
| `20260110000002_add_ccu_source_tracking.sql` | CCU source provenance |
| `20260110000003_add_ccu_tiered_tracking.sql` | CCU tiers, snapshots, functions |
| `20260110000004_add_ccu_skip_tracking.sql` | CCU skip tracking for invalid appids |
| `20260110000005_add_store_asset_mtime.sql` | Rename page_creation_date to store_asset_mtime |
| `20260110000006_remove_scraper_from_sync_functions.sql` | Remove scraper references from sync functions |
| `20260111000001_add_last_ccu_synced.sql` | CCU rotation tracking column |

---

## Upgrade Instructions

1. **Apply Migrations**
   ```bash
   supabase db push
   ```

2. **Regenerate Types**
   ```bash
   pnpm --filter database generate
   pnpm build
   ```

3. **Deploy Workers**
   - Update GitHub Actions workflows
   - New workflows: `ccu-daily-sync.yml`, `ccu-cleanup.yml`
   - Modified: `ccu-sync.yml`, `reviews-sync.yml`, `steamspy-sync.yml`

4. **Initial Tier Assignment**
   ```sql
   SELECT recalculate_ccu_tiers();
   ```

5. **Verify Tiers**
   ```sql
   SELECT ccu_tier, COUNT(*) FROM ccu_tier_assignments GROUP BY ccu_tier;
   ```

---

## Related Documentation

- [Database Schema](../developer-guide/architecture/database-schema.md) - Full table definitions
- [Sync Pipeline](../developer-guide/architecture/sync-pipeline.md) - Data flow details
- [Data Sources](../developer-guide/architecture/data-sources.md) - API specifications
- [GitHub Actions](../developer-guide/deployment/github-actions.md) - Workflow schedules
- [Running Workers](../developer-guide/workers/running-workers.md) - Manual execution commands
