# v2.2 Release Notes - Tiered CCU & SteamSpy Improvements

**Release Date:** January 9, 2026

---

## Overview

Version 2.2 introduces intelligent tiered CCU (concurrent user) tracking using Steam's native API, along with improvements to SteamSpy data collection, rate limits, and priority calculation. This release focuses on data quality and collection efficiency.

### Highlights

- **Tiered CCU Tracking** - Three-tier system with hourly, 2-hourly, and daily polling based on game activity
- **Exact CCU Data** - Direct Steam API integration replaces SteamSpy estimates for player counts
- **SteamSpy Supplementary Fetch** - Fills gaps in SteamSpy pagination for popular games
- **3x Reviews Throughput** - Rate limit increased from 0.33 to 1 req/sec
- **Priority Fix** - Never-synced apps now receive proper priority for initial enrichment

---

## Tiered CCU Tracking System

### Overview

Replaces simple hourly polling with an intelligent three-tier system that optimizes API calls based on game activity levels.

### Tier Definitions

| Tier | Criteria | Polling Frequency | Games |
|------|----------|-------------------|-------|
| **Tier 1** | Top 500 by 7-day peak CCU | Hourly | ~500 |
| **Tier 2** | Top 1000 newest releases (past year) | Every 2 hours (even hours only) | ~1000 |
| **Tier 3** | All other games | Daily | ~60,000+ |

### Data Flow

```
Steam GetNumberOfCurrentPlayers API
          ↓
ccu-tiered-worker (hourly, Tier 1+2)
          ↓
ccu_snapshots (30-day retention)
          ↓
ccu-cleanup workflow (weekly)
          ↓
daily_metrics (ccu_peak, ccu_source='steam_api')
```

### New Database Tables

#### `ccu_snapshots`

Stores hourly/2-hourly CCU snapshots for Tier 1+2 games.

| Column | Type | Description |
|--------|------|-------------|
| id | BIGSERIAL | Primary key |
| appid | INTEGER | FK to apps |
| snapshot_time | TIMESTAMPTZ | Snapshot timestamp |
| player_count | INTEGER | Exact CCU from Steam API |
| ccu_tier | SMALLINT | Tier at snapshot time (1/2/3) |

**Retention:** 30 days, then aggregated to `daily_metrics`

#### `ccu_tier_assignments`

Current tier assignment for each game, recalculated hourly.

| Column | Type | Description |
|--------|------|-------------|
| appid | INTEGER | PK, FK to apps |
| ccu_tier | SMALLINT | Current tier (1/2/3) |
| tier_reason | TEXT | 'top_ccu', 'new_release', 'default' |
| recent_peak_ccu | INTEGER | 7-day peak CCU |
| release_rank | INTEGER | Rank by release date (for Tier 2) |
| last_tier_change | TIMESTAMPTZ | When tier last changed |
| updated_at | TIMESTAMPTZ | Last update time |

### New Column: `daily_metrics.ccu_source`

Tracks data provenance:
- `'steam_api'` - Exact CCU from Steam's GetNumberOfCurrentPlayers API
- `'steamspy'` - Estimated CCU from SteamSpy
- `NULL` - Legacy data (source unknown)

### New RPC Functions

| Function | Purpose |
|----------|---------|
| `recalculate_ccu_tiers()` | Reassigns tiers based on 7-day peak CCU and release date |
| `cleanup_old_ccu_snapshots()` | Deletes snapshots older than 30 days |
| `aggregate_daily_ccu_peaks(target_date)` | Rolls up hourly snapshots to daily_metrics |

### New Workers

#### CCU Tiered Worker (`ccu-tiered-worker.ts`)

- Runs hourly via GitHub Actions
- Polls Tier 1 games every hour
- Polls Tier 2 games every 2 hours (even hours only)
- Creates `ccu_snapshots` records
- Updates `daily_metrics` with peak values
- Recalculates tier assignments at midnight UTC

```bash
pnpm --filter @publisheriq/ingestion ccu-tiered-sync
```

#### CCU Daily Worker (`ccu-daily-worker.ts`)

- Runs daily at 4:30 AM UTC
- Polls all Tier 3 games (~50,000+)
- Supports `CCU_DAILY_LIMIT` env var (default: 50,000)

```bash
pnpm --filter @publisheriq/ingestion ccu-daily-sync
```

### New GitHub Workflows

| Workflow | Schedule | Purpose |
|----------|----------|---------|
| `ccu-sync.yml` | Hourly at :00 | Tier 1+2 CCU polling |
| `ccu-daily-sync.yml` | Daily 4:30 AM UTC | Tier 3 CCU polling |
| `ccu-cleanup.yml` | Weekly Sun 3 AM UTC | Aggregate + cleanup old snapshots |

### Benefits

- **Exact Data**: Steam API returns real-time player counts, not estimates
- **Hourly Granularity**: Top games tracked every hour for accurate peak detection
- **Automatic Tier Movement**: Games automatically move between tiers as activity changes
- **Efficient Resource Use**: Low-activity games polled less frequently
- **Trend Analysis**: 30-day snapshot retention enables CCU trend visualization

---

## SteamSpy Supplementary Fetch

### Problem

SteamSpy's paginated "all" API returns only ~86,000 apps, missing some popular games like Arc Raiders (120K reviews) that are available via the individual `appdetails` endpoint.

### Solution

Added supplementary fetch logic to `steamspy-worker.ts` that:
1. Identifies games with 1000+ reviews but no SteamSpy data
2. Fetches individual app details via `appdetails` endpoint
3. Runs during full sync, adds ~2 minutes to 90-minute sync

### New Database Column

`sync_status.last_steamspy_individual_fetch` - Tracks when individual fetch was attempted

### New RPC Function

`get_steamspy_individual_fetch_candidates(p_limit, p_min_reviews)` - Returns high-priority games missing from SteamSpy pagination

### Configuration

| Environment Variable | Default | Description |
|---------------------|---------|-------------|
| `SUPPLEMENTARY_LIMIT` | 100 | Max games per supplementary fetch |

---

## Rate Limit & Batch Size Changes

### Reviews API

| Parameter | Before | After | Improvement |
|-----------|--------|-------|-------------|
| Rate limit | 0.33 req/sec | 1 req/sec | 3x |
| Batch size | 1,200 apps | 2,500 apps | 2x |
| Daily capacity | ~14,000 apps | ~30,000 apps | 2x |

**Rationale:** Reviews API uses lightweight summary endpoint (`num_per_page=0`) that only returns aggregate counts, not individual reviews.

### Steam CCU API

New rate limiter added:
- **Rate:** 1 req/sec (conservative)
- **Burst:** 5 requests

---

## Priority Calculation Fix

### Problem

Never-synced apps were incorrectly receiving the "dead game" penalty (-50 points), causing them to never be prioritized for initial data enrichment. This affected ~11,000 games including titles like ARC Raiders.

### Fix

Never-synced apps now receive a base priority of 25 (moderate tier), ensuring:
- Initial sync within 48 hours
- Proper discovery in chat queries
- Correct categorization after first metrics collection

### Priority Algorithm

```javascript
// Before: All apps without metrics got dead penalty
if (ccu === 0 && velocity7d < 0.1) {
  priority -= 50; // ❌ Applied to never-synced apps
}

// After: Only previously-synced apps get dead penalty
const neverSynced = !app.last_reviews_sync && !app.last_steamspy_sync;
if (neverSynced) {
  priority = 25; // Base priority for new games
} else if (ccu === 0 && velocity7d < 0.1) {
  priority -= 50; // Only for previously-synced inactive games
}
```

---

## Materialized View Auto-Refresh

### New Function

`refresh_mat_views()` - Concurrently refreshes all materialized views:
- `latest_daily_metrics`
- `publisher_metrics`
- `developer_metrics`
- `publisher_year_metrics`
- `developer_year_metrics`
- `publisher_game_metrics`
- `developer_game_metrics`
- `review_velocity_stats`

### New Workflow

`refresh-views.yml` runs:
- Daily at 5 AM UTC
- After `steamspy-sync` completes (workflow dispatch)

---

## DailyMetrics Cube Fix

Removed invalid `name` dimension from DailyMetrics Cube.js model. The dimension was causing cross-cube reference errors. Name-based queries should use:
- `lookup_games` tool for name → appid resolution
- `Discovery` cube for game data with names

---

## Database Migrations

| Migration | Purpose |
|-----------|---------|
| `20260110000001_add_steamspy_individual_fetch_tracking.sql` | Supplementary fetch column |
| `20260110000002_add_ccu_source_tracking.sql` | CCU source provenance |
| `20260110000003_add_ccu_tiered_tracking.sql` | CCU tiers, snapshots, functions |

---

## Upgrade Instructions

1. **Apply Migrations**
   ```bash
   supabase db push
   ```

2. **Regenerate Types**
   ```bash
   pnpm --filter database generate
   pnpm build
   ```

3. **Deploy Workers**
   - Update GitHub Actions workflows
   - New workflows: `ccu-daily-sync.yml`, `ccu-cleanup.yml`
   - Modified: `ccu-sync.yml`, `reviews-sync.yml`, `steamspy-sync.yml`

4. **Initial Tier Assignment**
   ```sql
   SELECT recalculate_ccu_tiers();
   ```

5. **Verify Tiers**
   ```sql
   SELECT ccu_tier, COUNT(*) FROM ccu_tier_assignments GROUP BY ccu_tier;
   ```

---

## Related Documentation

- [Database Schema](../architecture/database-schema.md) - Full table definitions
- [Sync Pipeline](../architecture/sync-pipeline.md) - Data flow details
- [Data Sources](../architecture/data-sources.md) - API specifications
- [GitHub Actions](../deployment/github-actions.md) - Workflow schedules
- [Running Workers](../guides/running-workers.md) - Manual execution commands
