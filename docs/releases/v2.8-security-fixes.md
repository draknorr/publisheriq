# v2.8 Release Notes - Security Fixes & Authentication Overhaul

**Release Date:** January 31, 2026

---

## Overview

Version 2.8 is a critical security and stability release addressing vulnerabilities in the authentication system, fixing page timeouts, and resolving client-side data fetching issues on the Apps and Companies pages.

### Highlights

- **Security Fixes** - 14 vulnerabilities patched including privilege escalation and auth bypass risks
- **OTP Authentication** - Standardized 8-digit verification codes with 10-minute expiry
- **Token Refresh Loop Fix** - Resolved infinite refresh loops on login page
- **Apps Page Sparkline Fix** - Fixed trend lines not rendering (em-dash display)
- **Companies Page Client Fix** - Corrected Supabase client pattern for hooks
- **New Environment Variable** - `NEXT_PUBLIC_SITE_URL` for secure redirects

---

## Security Fixes

### Critical Vulnerabilities Patched

| ID | Issue | Risk | Resolution |
|----|-------|------|------------|
| AUTH-01 | Dev bypass could become production auth bypass | Critical | Gated behind `NODE_ENV === 'development'` |
| DB-01 | RLS policy allowed users to escalate privileges | Critical | Column-level UPDATE grants implemented |
| DB-02 | SECURITY DEFINER functions callable by any user | Critical | Added `auth.uid()` validation |
| DB-03 | `chat_query_logs` publicly readable | High | Admin-only SELECT policy |

### High Priority Fixes

| ID | Issue | Resolution |
|----|-------|------------|
| AUTH-02 | Open redirect via `origin` parameter | Allowlist validation |
| AUTH-06 | API routes relied only on middleware | Defense-in-depth auth checks |
| AUTH-07 | Host header injection in redirects | Use `NEXT_PUBLIC_SITE_URL` |

### Medium Priority Fixes

- AUTH-03: Fixed `redirect` vs `next` parameter mismatch
- AUTH-04: Replaced `listUsers()` with direct lookup
- AUTH-10: Standardized Supabase client usage patterns

---

## OTP Authentication System

The login flow now uses standardized OTP (One-Time Password) codes:

| Setting | Value |
|---------|-------|
| Code length | 8 digits |
| Code expiry | 10 minutes |
| Rate limit | 3 attempts per 15 minutes |

### Login Flow

1. User enters email on `/login`
2. System validates against waitlist
3. OTP email sent with 8-digit code
4. User enters code to complete sign-in
5. Session established with secure cookies

### Troubleshooting OTP

**Code not arriving:**
- Check spam/junk folder
- Verify email is on approved waitlist
- Wait 60 seconds before requesting new code

**Code expired:**
- Codes expire after 10 minutes
- Request a new code from the login page

**Too many attempts:**
- Rate limited after 3 failed attempts
- Wait 15 minutes before retrying

---

## Token Refresh Loop Fix

Fixed an issue where the login page would enter an infinite token refresh loop.

### Root Cause

Stale tokens in storage would trigger continuous refresh attempts, causing the page to become unresponsive.

### Solution

- Clear stale tokens on login page mount
- Use no-refresh Supabase client for login page
- Add loop detection with automatic recovery

### Affected Commits

- `5912da7` - Clear stale tokens on login page
- `9f884bd` - Use no-refresh Supabase client

---

## Apps Page Fixes

### Sparkline Trend Lines (commit 3c2dda3)

**Issue:** Sparklines displayed em-dash (`---`) instead of trend charts.

**Root Cause:** The `useSparklineLoader` hook used `getSupabase()` which creates an anon-key client without session awareness. The RPC call failed silently and cached empty results.

**Fix:** Changed to `createBrowserClient()` pattern which is cookie/session-aware:

```typescript
// Before (broken)
const supabase = getSupabase();

// After (fixed)
const supabase = createBrowserClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);
```

### Page Timeout (commit dc8dbd8)

**Issue:** Apps page timing out on initial load.

**Root Cause:** Server Component using session-aware client instead of service role.

**Fix:** Use service role client for Server Component data fetching, reserving session-aware clients for client-side operations.

---

## Companies Page Fix

### Client Hooks (commit dc8dbd8)

**Issue:** Client-side hooks failing to fetch data.

**Fix:** Updated all client hooks to use `createBrowserClient()` pattern consistent with the Apps page fix.

Affected hooks:
- `useSparklineLoader`
- `useFilterCounts`
- `useCompaniesCompare`

---

## New Environment Variable

### NEXT_PUBLIC_SITE_URL

A new environment variable is required for secure redirect handling:

```bash
# apps/admin/.env.local
NEXT_PUBLIC_SITE_URL=https://publisheriq.app
```

**Purpose:**
- Provides canonical base URL for redirects
- Prevents host header injection attacks
- Required for OTP email redirect links

**Format:**
- Must include protocol (`https://`)
- No trailing slash
- Use production domain in production

---

## Supabase Client Patterns

This release standardizes Supabase client usage across the codebase.

### Pattern Reference

| Context | Client | Use Case |
|---------|--------|----------|
| Server Component | `createServerClient()` with service role | Initial page data |
| API Route | `createServerClient()` with cookies | Authenticated requests |
| Client Hook | `createBrowserClient()` | Session-aware fetching |
| Public data | `getSupabase()` (anon) | Unauthenticated reads |

### When to Use Each

**Server Components (page.tsx):**
```typescript
import { createServiceClient } from '@/lib/supabase/server';

export default async function Page() {
  const supabase = createServiceClient();
  const { data } = await supabase.from('apps').select('*');
}
```

**Client Hooks:**
```typescript
import { createBrowserClient } from '@supabase/ssr';

function useMyHook() {
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
  // Uses session cookies automatically
}
```

---

## Migration Guide

### Required Steps

1. **Add environment variable:**
   ```bash
   NEXT_PUBLIC_SITE_URL=https://your-domain.com
   ```

2. **Update Supabase email templates** (if customized):
   - Ensure OTP template uses 8-digit codes
   - Set expiry to 10 minutes

3. **Deploy database migrations:**
   - New RLS policies for `chat_query_logs`
   - Updated credit functions with auth validation

### Breaking Changes

None. All changes are backward compatible.

---

## Verification Checklist

After deploying v2.8, verify:

- [ ] Login flow completes successfully
- [ ] OTP codes arrive and are accepted
- [ ] Apps page sparklines render (not `---`)
- [ ] Companies page loads without timeout
- [ ] Admin pages require admin role
- [ ] Chat logs are not publicly accessible

---

## Related Documentation

- [Troubleshooting Guide](../admin-guide/troubleshooting.md) - Common issues and solutions
- [Games Page Architecture](../developer-guide/features/games-page.md) - Technical details
- [Companies Page Architecture](../developer-guide/features/companies-page.md) - Technical details
- [v2.7 Release Notes](./v2.7-design-command-palette.md) - Previous release
