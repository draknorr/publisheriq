# PublisherIQ v2.1 - Velocity-Based Sync & Authentication

**Release Date:** January 8, 2026
**Branch:** `main`
**Total Commits:** 15+
**Net Code Change:** +3,200 lines

## Executive Summary

Version 2.1 introduces two major features:

1. **Velocity-Based Review Sync Scheduling** - Intelligent sync intervals based on review activity
2. **User Authentication & Credits System** - Magic link auth with invite-only waitlist
3. **New LLM Tool: lookup_games** - Direct game name searches
4. **New Cube.js Models** - ReviewVelocity, ReviewDeltas for trend analysis

---

## Changelog by Category

### Velocity-Based Review Sync (5 commits)

| Commit | Description |
|--------|-------------|
| `e7467bf` | Add velocity-based review sync scheduling and delta tracking |
| `a281113` | Fix priority calculation bug preventing never-synced apps from appearing |
| - | Add review_deltas table for daily review change tracking |
| - | Add review_velocity_stats materialized view |
| - | Add interpolation function to fill gaps in trend data |

**Key Files Added/Modified:**
- `supabase/migrations/20260109100000_add_review_deltas.sql` - Delta tracking table
- `supabase/migrations/20260109100001_add_velocity_columns.sql` - sync_status velocity columns
- `supabase/migrations/20260109100002_add_velocity_view.sql` - Velocity stats view
- `packages/cube/model/ReviewVelocity.js` - New Cube.js model
- `packages/cube/model/ReviewDeltas.js` - New Cube.js model
- `packages/ingestion/src/workers/velocity-calculator-worker.ts` - New worker
- `packages/ingestion/src/workers/interpolation-worker.ts` - New worker

---

### User Authentication & Credits System (4 commits)

| Commit | Description |
|--------|-------------|
| `ed08740` | Add user authentication and credits system |
| `99f9aa5` | Add email validation to restrict sign-in to approved users |
| `132ca7b` | Create public landing page and restructure routing |
| - | Fix RLS recursion issues with user profiles |

**Key Files Added/Modified:**
- `supabase/migrations/20260108000000_add_user_system.sql` - Complete auth/credits schema
- `apps/admin/src/app/(auth)/login/page.tsx` - Magic link login
- `apps/admin/src/app/(auth)/waitlist/page.tsx` - Waitlist signup
- `apps/admin/src/app/(main)/admin/users/page.tsx` - User management
- `apps/admin/src/app/(main)/admin/waitlist/page.tsx` - Waitlist approval
- `apps/admin/src/app/page.tsx` - Public landing page

---

### Chat System Improvements (2 commits)

| Commit | Description |
|--------|-------------|
| `1f2314f` | Add lookup_games tool for specific game name queries |
| `a340a87` | Add missing cubes to query_analytics tool enum |

**Key Files Modified:**
- `apps/admin/src/lib/llm/cube-tools.ts` - Added lookup_games tool, expanded cube enum
- `apps/admin/src/lib/search/game-lookup.ts` - New game lookup implementation

---

### Infrastructure Improvements (2 commits)

| Commit | Description |
|--------|-------------|
| - | Add refresh-views workflow for automated materialized view refresh |
| - | Add velocity-calculation and interpolation workflows |

**Key Files Added:**
- `.github/workflows/velocity-calculation.yml` - 3x daily velocity refresh
- `.github/workflows/interpolation.yml` - Daily data gap filling
- `.github/workflows/refresh-views.yml` - Daily materialized view refresh

---

## New Features in Detail

### Velocity-Based Review Sync Scheduling

Games are now synced based on their review velocity (reviews/day), enabling efficient resource allocation:

#### Velocity Tiers

| Tier | Reviews/Day | Sync Interval | Description |
|------|-------------|---------------|-------------|
| `high` | >= 5 | 4 hours | Active games with many reviews |
| `medium` | 1-5 | 12 hours | Moderate review activity |
| `low` | 0.1-1 | 24 hours | Low but non-zero activity |
| `dormant` | < 0.1 | 72 hours | Minimal review activity |

#### How It Works

```
Reviews Sync → review_deltas (daily snapshots)
            → review_velocity_stats (materialized view)
            → sync_status.velocity_7d
            → sync_status.review_velocity_tier
            → sync_status.reviews_interval_hours
            → sync_status.next_reviews_sync
```

#### New sync_status Columns

| Column | Type | Description |
|--------|------|-------------|
| `next_reviews_sync` | TIMESTAMPTZ | When app is due for review sync |
| `reviews_interval_hours` | INTEGER | Hours between review syncs (4/12/24/72) |
| `review_velocity_tier` | TEXT | Current velocity tier |
| `velocity_7d` | DECIMAL | 7-day average reviews/day |
| `velocity_calculated_at` | TIMESTAMPTZ | Last velocity calculation time |

---

### Review Delta Tracking

New `review_deltas` table stores daily review changes for trend visualization:

| Column | Type | Description |
|--------|------|-------------|
| `appid` | INTEGER | Game ID |
| `delta_date` | DATE | Date of snapshot |
| `total_reviews` | INTEGER | Absolute review count |
| `positive_reviews` | INTEGER | Absolute positive count |
| `reviews_added` | INTEGER | Delta from previous sync |
| `daily_velocity` | DECIMAL | Reviews/day (normalized to 24h) |
| `is_interpolated` | BOOLEAN | TRUE if estimated between syncs |

**Interpolation**: Gaps in sync data are automatically filled with linear interpolation for continuous time-series charts.

---

### New Cube.js Models

#### ReviewVelocity Cube

Pre-computed velocity stats for discovery and analytics.

**Source**: `review_velocity_stats` materialized view

**Dimensions**:
- `appid` - Game ID
- `velocity7d` - 7-day average reviews/day
- `velocity30d` - 30-day average reviews/day
- `velocityTier` - 'high', 'medium', 'low', 'dormant'
- `reviewsAdded7d` - Total reviews added in 7 days
- `reviewsAdded30d` - Total reviews added in 30 days
- `velocityTrend` - 'accelerating', 'stable', 'decelerating'

**Segments**:
- `highVelocity` - velocity_tier = 'high'
- `mediumVelocity` - velocity_tier = 'medium'
- `lowVelocity` - velocity_tier = 'low'
- `dormant` - velocity_tier = 'dormant'
- `accelerating` - 7d velocity > 30d velocity * 1.2
- `decelerating` - 7d velocity < 30d velocity * 0.8

#### ReviewDeltas Cube

Time-series data for per-game review trend charts.

**Source**: `review_deltas` table

**Dimensions**:
- `appid` - Game ID
- `deltaDate` - Snapshot date
- `totalReviews` - Absolute value
- `reviewsAdded` - Delta since last sync
- `dailyVelocity` - Normalized reviews/day
- `isInterpolated` - Data source indicator

**Segments**:
- `actualOnly` - Only real API syncs
- `interpolatedOnly` - Only gap-filled data
- `hasActivity` - reviews_added > 0
- `highVelocity` - daily_velocity >= 5

---

### User Authentication System

Complete authentication and access control system:

#### Authentication Flow

1. User visits `/login`
2. Enters email address
3. System validates email against approved waitlist
4. If approved, sends magic link via Supabase Auth
5. User clicks link and is signed in
6. User profile created with signup bonus credits

#### New ENUMs

```sql
CREATE TYPE user_role AS ENUM ('user', 'admin');
CREATE TYPE waitlist_status AS ENUM ('pending', 'approved', 'rejected');
CREATE TYPE credit_transaction_type AS ENUM (
    'signup_bonus', 'admin_grant', 'admin_deduct', 'chat_usage', 'refund'
);
CREATE TYPE credit_reservation_status AS ENUM ('pending', 'finalized', 'refunded');
```

#### New Tables

| Table | Purpose |
|-------|---------|
| `user_profiles` | User data: role, credits, usage stats |
| `waitlist` | Signup requests with approval status |
| `credit_transactions` | Immutable audit log of credit movements |
| `credit_reservations` | Deduct-at-start pattern for chat |
| `rate_limit_state` | Per-user rate limiting |

#### Credit System

- **Signup Bonus**: 1000 credits ($10 equivalent)
- **Reservation Pattern**: Credits reserved before chat, finalized after
- **Automatic Refund**: Full refund on server errors
- **Rate Limits**: 20/minute, 200/hour per user

#### New Admin Pages

| Page | Purpose |
|------|---------|
| `/admin/users` | User management, credit grants/deductions |
| `/admin/waitlist` | Approve/reject waitlist requests |
| `/admin/usage` | Credit usage analytics |

---

### New LLM Tool: lookup_games

Searches games by name using ILIKE partial match.

```json
{
  "name": "lookup_games",
  "parameters": {
    "query": "Elden Ring",
    "limit": 10
  }
}
```

**Returns**: `[{appid: 1245620, name: "ELDEN RING", releaseYear: 2022}]`

**Use Case**: Find appid before querying metrics with `query_analytics`.

---

### Updated query_analytics Tool

Now includes 11 cubes (up from 4):

- Discovery
- PublisherMetrics, PublisherYearMetrics, PublisherGameMetrics
- DeveloperMetrics, DeveloperYearMetrics, DeveloperGameMetrics
- DailyMetrics, LatestMetrics
- MonthlyGameMetrics, MonthlyPublisherMetrics

---

## Database Migrations

| Migration | Purpose |
|-----------|---------|
| `20260108000000_add_user_system.sql` | Complete auth/credits system |
| `20260109100000_add_review_deltas.sql` | Review delta tracking table |
| `20260109100001_add_velocity_columns.sql` | sync_status velocity columns |
| `20260109100002_add_velocity_view.sql` | review_velocity_stats view |

### Migration Commands

```bash
# Apply all migrations
npx supabase db push

# Or apply individually
npx supabase migration up 20260108000000
npx supabase migration up 20260109100000
npx supabase migration up 20260109100001
npx supabase migration up 20260109100002
```

---

## New GitHub Actions Workflows

| Workflow | Schedule (UTC) | Purpose |
|----------|----------------|---------|
| `velocity-calculation.yml` | 08:00, 16:00, 00:00 | Refresh velocity stats |
| `interpolation.yml` | 05:00 daily | Fill review data gaps |
| `refresh-views.yml` | 05:00 daily | Refresh materialized views |

---

## New Workers

| Worker | Script | Purpose |
|--------|--------|---------|
| `velocity-calculator-worker.ts` | `pnpm --filter @publisheriq/ingestion calculate-velocity` | Refresh velocity stats |
| `interpolation-worker.ts` | `pnpm --filter @publisheriq/ingestion interpolate-reviews` | Fill data gaps |
| `refresh-views-worker.ts` | `pnpm --filter @publisheriq/ingestion refresh-views` | Refresh materialized views |

---

## New Components

| Component | Location | Purpose |
|-----------|----------|---------|
| `LoginPage` | `apps/admin/src/app/(auth)/login/` | Magic link authentication |
| `WaitlistPage` | `apps/admin/src/app/(auth)/waitlist/` | Waitlist signup form |
| `UserManagement` | `apps/admin/src/app/(main)/admin/users/` | Admin user management |
| `WaitlistAdmin` | `apps/admin/src/app/(main)/admin/waitlist/` | Waitlist approval interface |
| `LandingPage` | `apps/admin/src/app/page.tsx` | Public landing page |

---

## Breaking Changes

### Routing Changes

| Before | After |
|--------|-------|
| `/` | `/dashboard` (protected) |
| N/A | `/` (public landing page) |
| N/A | `/login` (magic link auth) |
| N/A | `/waitlist` (signup form) |

### Environment Variables

New required variables if using authentication:

```bash
AUTH_MODE=magic_link           # Enable auth system
CREDITS_ENABLED=true           # Enable credit system
```

### API Changes

- `/api/chat/stream` now requires authentication when `AUTH_MODE` is set
- `/api/similarity` now requires authentication when `AUTH_MODE` is set

---

## Upgrade Instructions

1. **Pull latest code:**
   ```bash
   git checkout main
   git pull origin main
   ```

2. **Install dependencies:**
   ```bash
   pnpm install
   ```

3. **Apply database migrations:**
   ```bash
   npx supabase db push
   ```

4. **Refresh materialized views:**
   ```sql
   REFRESH MATERIALIZED VIEW CONCURRENTLY publisher_metrics;
   REFRESH MATERIALIZED VIEW CONCURRENTLY developer_metrics;
   SELECT refresh_review_velocity_stats();
   ```

5. **Configure environment (if using auth):**
   ```bash
   # Add to apps/admin/.env.local
   AUTH_MODE=magic_link
   CREDITS_ENABLED=true
   ```

6. **Rebuild and deploy:**
   ```bash
   pnpm build
   ```

7. **Enable new GitHub Actions workflows:**
   - velocity-calculation.yml
   - interpolation.yml
   - refresh-views.yml

---

## Related Documentation

- [Database Schema](../architecture/database-schema.md) - Updated with new tables
- [Chat Data System](../architecture/chat-data-system.md) - New tools and cubes
- [Sync Pipeline](../architecture/sync-pipeline.md) - Velocity scheduling details
- [Running Workers](../guides/running-workers.md) - New worker commands
- [Troubleshooting](../guides/troubleshooting.md) - Auth and velocity issues
